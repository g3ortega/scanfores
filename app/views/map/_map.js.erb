$(document).ready(function() {
    var map;
    var centre = new google.maps.LatLng(13.1864581,-85.9448642);
    var colour = '#6d9654'

    function initialize() {
	map = new google.maps.Map(document.getElementById('map'),
			          { center: centre, zoom: 9,
                                    mapTypeId: google.maps.MapTypeId.HYBRID,
                                    zoomControlOptions: {
                                        style: google.maps.ZoomControlStyle.LARGE
                                    },
                                    streetViewControl: false });
        setMarkers(map, locats);
        infowindow = new google.maps.InfoWindow({
            content: "loading..."
        });
        // Try W3C Geolocation
        if(navigator.geolocation) {
            browserSupportFlag = true;
            navigator.geolocation.getCurrentPosition(function(position) {
                initialLocation = new google.maps.LatLng(position.coords.latitude,position.coords.longitude);
                map.setCenter(initialLocation);
            }, function() {
                handleNoGeolocation(browserSupportFlag);
            });
        }
        // Browser doesn't support Geolocation
        else {
            browserSupportFlag = false;
            handleNoGeolocation(browserSupportFlag);
        }

        function handleNoGeolocation(errorFlag) {
            if (errorFlag == true) {
                alert("Geolocation service failed.");
                initialLocation = newyork;
            } else {
                alert("Your browser doesn't support geolocation. We've placed you in Siberia.");
                initialLocation = siberia;
            }
            map.setCenter(initialLocation);
        }
    }

    var locats =[]
    var alertcircle;
    <% @alerts.each do |alert| %>
    locats.push(['<%=  alert.description['reason1'] %>','<%=  alert.lat %>','<%=  alert.lon %>', <%=  alert.area %>]);
    <%end%>

    function setMarkers(map, locations) {

        var shape = {
            coords: [1, 1, 1, 20, 18, 20, 18 , 1],
            type: 'poly'
        };
        var markert=[];
        for (var i = 0; i < locats.length; i++) {
            var location = locats[i];
            var myLatLng = new google.maps.LatLng(location[1], location[2]);
            var circe = {
                fillColor: colour,
                strokeOpacity: 0,
                strokeWeight: 2.3,
                fillOpacity: 0.3,
                center:  myLatLng,
                radius: location[3] ,
                map:map
            };
            var image = {
                url: "<%= asset_path('maakad.png') %>",
                // This marker is 20 pixels wide by 32 pixels tall.
                size: new google.maps.Size(22, 34),
                // The origin for this image is 0,0.
                origin: new google.maps.Point(0,0),

                anchor: new google.maps.Point(10, 10)
            };
            var marker = new google.maps.Marker({
                position: myLatLng,
                map: map,
                icon: image,
                shape: shape,
                title: location[0],
                zIndex: location[3]
            });
            markert.push(marker);
            alertcircle = new google.maps.Circle(circe);

        }
    }

    google.maps.event.addDomListener(window, 'load', initialize);
});
